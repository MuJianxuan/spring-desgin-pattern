package org.designpattern.spring.state;

import com.alibaba.fastjson.JSON;
import org.designpattern.spring.state.core.*;
import org.designpattern.spring.state.order.*;
import org.designpattern.spring.state.order.StateMachine;

/**
 * çŠ¶æ€æ¨¡å¼æœ‰ç‚¹åƒç­–ç•¥æ¨¡å¼
 *
 * çŠ¶æ€æœº
 *
 * @author Rao
 * @Date 2021-10-20
 **/
public class StateTest {

    private static ChannelState state = new AvailableState();

    public static void study() throws Exception{
        /**
         * çŠ¶æ€è®¾è®¡æ¨¡å¼ï¼š
         *  1ã€çŠ¶æ€å¯ä»¥æ˜¯ç±» ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªå±æ€§ï¼Œé¢å‘å¯¹è±¡å¼€å‘ï¼Œå±æ€§çœ‹ä½œæ˜¯ä¸€ä¸ªå¯¹è±¡ä¹Ÿæ²¡ä»€ä¹ˆä¸åŒï¼›
         *  2ã€çŠ¶æ€è®¾è®¡æ¨¡å¼çš„è¦ç‚¹åœ¨äº å¯¹çŠ¶æ€å˜åŒ–çš„è¿‡ç¨‹ï¼ˆæˆ– å¤„äºä¸åŒçš„çŠ¶æ€ï¼‰å¯ä»¥é€‰æ‹©ä¸åŒçš„æ‰§è¡Œï¼Œæˆ‘è®¤ä¸ºè¿™ä¸€ç‚¹å’Œç­–ç•¥æ¨¡å¼æ˜¯æœ‰ç±»ä¼¼çš„ã€‚
         *  ä¸šåŠ¡ä¸­å…ä¸äº†ä¸åŒçŠ¶æ€åšä¸åŒå¤„ç†çš„ä»£ç ï¼Œç®€å•æƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦ç”¨if-else,switch-caseå°±å¯ä»¥å®ç°ã€‚ä»¥ä¸‹æƒ…å†µï¼Œè¯·è€ƒè™‘ä½¿ç”¨çŠ¶æ€æœºæ¨¡å¼ã€‚
         *  3ã€çŠ¶æ€æ¨¡å¼ çš„æ ¸å¿ƒç‚¹æ˜¯ å¯¹è±¡å¤„äºä½•ç§çŠ¶æ€ä¸‹çš„è¡Œä¸ºä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–
         *  ï¼ˆä¸ä¸€å®šå°±å‘ç”Ÿå˜åŒ–ï¼Œæœ‰å¯èƒ½ä¸å˜ï¼Œæ‰€ä»¥ä¼šå‡ºç°ç©ºå®ç°ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å®šä¹‰çˆ¶ç±»æ¥æ§åˆ¶ï¼Œæ¯”å¦‚æˆ‘å¤šç§çŠ¶æ€ä¸‹çš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼‰
         *  4ã€çŠ¶æ€è®¾è®¡æ¨¡å¼åº”ç”¨åœºæ™¯ï¼Œæˆ‘è§‰å¾—åœ¨è®¾è®¡ä¸Šå¯ä»¥è€ƒè™‘ä¸€ç§ å…¨å±€çš„çŠ¶æ€æ ‡è¯†ï¼Œæ¯”å¦‚ ç¬¬ä¸‰æ–¹æ¸ é“çŠ¶æ€ï¼Œ
         *  æ¯”å¦‚ä¸€ç¯‡æ–‡ç« çš„çŠ¶æ€ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªäººå·²ç»å°†æ–‡ç« å¤„äºç¼–è¾‘çŠ¶æ€äº†ï¼Œé‚£ä¹ˆå…¶ä»–äººå°è¯•ç¼–è¾‘åˆ™æ— æ³•æ‰“å¼€ï¼Œå› æ­¤è¿™ä¸ªæ—¶å€™å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨çŠ¶æ€æ¨¡å¼æ¥æ‰©å±•ï¼Œ
         *  åœ¨ä½¿ç”¨ è®¾è®¡æ¨¡å¼ åº”ç”¨æ—¶ï¼Œ ä¹Ÿä¸å¿…è¿‡åˆ†ä½¿ç”¨ï¼Œæœ‰ä¸€äº› if å¯ä»¥ç®€ç•¥çš„æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œé‡è¦æ˜¯ç†è§£è®¾è®¡æ¨¡å¼ä¸»è¦æ˜¯åšæ‰©å±•çš„ï¼Œæˆ‘è®¤ä¸ºä½¿ç”¨è®¾è®¡æ¨¡å¼è€ƒè™‘çš„ç‚¹æ˜¯ï¼Œ
         *  åœ¨è¿™ä¸ªåœºæ™¯å®ç°æ—¶ï¼Œèƒ½å»çŒœæƒ³ä¼šä¸ä¼šå‡ºç°å…¶ä»–å®ç°ï¼Œå›ºå®šçš„æ ¼å¼æ˜¯ä¸å¿…è¦ä½¿ç”¨è®¾è®¡æ¨¡å¼æ¥ä½¿å¾—ä»£ç å˜å¾—å¤šäº†ã€‚
         *
         *  çŠ¶æ€è¦è€ƒè™‘ æ˜¯ä¸ªå…¨å±€çŠ¶æ€å€¼ ï¼Œæ˜¯å¤§å®¶æ‰€è®¤çŸ¥çš„ã€‚ è¿™ç‚¹å¾ˆé‡è¦ã€‚
         *
         */

        // ç›®å‰çŠ¶æ€
        new Thread(() -> {
            try {
                Thread.sleep(600);
                // çŠ¶æ€å˜äº†
                state = new UnavailableState();

            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();

        // æ¨¡æ‹Ÿæœ‰è¯·æ±‚åœ¨æ‰§è¡Œ
        int count = 5;
        while (count-- > 0){

            state.createPrepaidOrder();
            Thread.sleep(200);

        }
    }

    public static void stateMachine() throws Exception{

        // è¿™é‡Œå’Œæƒ³æ³•æœ‰å‡ºå…¥ï¼Œ å¦‚ä½•è®©äº‹ä»¶å’Œ ä¸šåŠ¡ç»‘å®šæ˜¯ èšåˆçš„ä¸€ç§æƒ³æ³•
        // åˆ©ç”¨æ¥å£çš„ç‰¹æ€§ æä¾› è¿™ä¹ˆä¸€å¥—åŠŸèƒ½
        // ç›®å‰è¿™é‡Œ æœ‰ä¸€ä¸ªé—®é¢˜ æ˜¯ æ³¨è§£å¤„æ— æ³•ä½¿ç”¨ æšä¸¾çš„å€¼ ï¼Œè¿™å°±å¯¼è‡´ å¤„ç†ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œè¦ä¹ˆä½¿ç”¨ ç±»å¯¹æšä¸¾è¿›è¡ŒåŒºåˆ†ï¼Œå¦‚ State.class
        String key = StateKeyBuilder.builder()
                .business(BusinessStateMachineEnum.order.name())
                .triggerEvent(OrderStateEventEnum.create_event.name())
                .initState( StateContents.NO_STATUS )
                .nextState(OrderStateEnum.wait_pay.name())
                .build();

        System.out.println(key);

        StateContext<Order> stateContext = new StateContext<>();
        stateContext.setKey( key);
        StateResult<Order> result = StateMachine.handle(stateContext);
        System.out.println( "result: " + JSON.toJSONString( result));


    }

    public static void main(String[] args) throws Exception {
        // TODO è¿™é‡Œè®¾è®¡æœ‰é—®é¢˜

        /**
         * çŠ¶æ€æ¨¡å¼å®ç°ä¸€ä¸ªçŠ¶æ€æœºï¼ŒçŠ¶æ€æ¨¡å¼å°†æ¯ä¸€ä¸ªçŠ¶æ€å°è£…æˆç‹¬ç«‹çš„ç±»ï¼Œ
         * å…·ä½“è¡Œä¸ºä¼šéšç€å†…éƒ¨çŠ¶æ€è€Œæ”¹å˜ã€‚çŠ¶æ€æ¨¡å¼ç”¨ç±»è¡¨ç¤ºçŠ¶æ€ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡åˆ‡æ¢ç±»æ¥æ–¹ä¾¿åœ°æ”¹å˜å¯¹è±¡çš„çŠ¶æ€ï¼Œé¿å…äº†å†—é•¿çš„æ¡ä»¶åˆ†æ”¯è¯­å¥
         *
         *
         * ğŸƒã€SpringBootæŠ€æœ¯ä¸“é¢˜ã€‘ã€ŒStateMachineã€FSMçŠ¶æ€æœºè®¾è®¡åŠå®ç°
         * åŸæ–‡é“¾æ¥ï¼š https://xie.infoq.cn/article/ffc60200da80e7ad79acd6678
         */

        /**
         * æˆ‘è®¤ä¸º çŠ¶æ€æœºæ˜¯ çŠ¶æ€æœºï¼Œä¸çŠ¶æ€æ¨¡å¼ æ˜¯ä¸åŒçš„ï¼ŒçŠ¶æ€æ¨¡å¼ ä¾§é‡ä¸ å¯¹è±¡å†…åœ¨çš„çŠ¶æ€
         * è€ŒçŠ¶æ€æœºåˆ™æ˜¯å…³æ³¨ çŠ¶æ€å› ä»€ä¹ˆäº‹ä»¶æ‰­è½¬ä»€ä¹ˆçŠ¶æ€åå‘ç”Ÿè¡Œä¸ºå¹¶æ›´æ–°çŠ¶æ€ã€‚
         * è¡¥å…… ï¼š çŠ¶æ€æœºæ¯ä¸€ä¸ªå®ä¾‹éƒ½åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼Œæœ‰è‡ªå·±çš„ä¸»è¦æ‰­è½¬ï¼Œé‚£ä¹ˆå°±æœ‰çŠ¶æ€æœºçš„åˆå§‹ä»¥åŠçŠ¶æ€æœºçš„åŠ¨ä½œæ–¹å¼ï¼Œè‡ªåŠ¨è¿˜æ˜¯æ‰‹åŠ¨
         * é€šè¿‡å¯¹Spring machine çš„äº†è§£åï¼Œå¯¹çŠ¶æ€æœºçš„æ¦‚å¿µä»¥åŠè®¾æƒ³æ›´åŠ çš„å…·ä½“ï¼ŒçŠ¶æ€æœºæ˜¯ä¸€ä¸ª å¯¹è±¡å®ä¾‹ï¼Œä¸è®¢å•æ˜¯åŒä¸€ä¸ªä¸œä¸œï¼Œä¸€ä¸ªè®¢å•å°±åº”è¯¥å¯¹åº”ä¸€ä¸ªçŠ¶æ€æœº
         *
         */
        // ç®€å•çš„çŠ¶æ€æ¨¡å¼  >> å½“ä¸€ä¸ªå¯¹è±¡çš„å†…åœ¨çŠ¶æ€æ”¹å˜æ—¶å…è®¸æ”¹å˜å…¶è¡Œä¸ºï¼Œè¿™ä¸ªå¯¹è±¡çœ‹èµ·æ¥åƒæ˜¯æ”¹å˜äº†å…¶ç±»ã€‚
        // çŠ¶æ€æœºæ¨¡å¼

        stateMachine();

    }
}
